<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A humble mocking library for Kotlin, KotlinJS and Kotlin Multiplatform using Kotlin Symbol Processing (KSP)."><meta name=author content="Matthias Geisler"><link href=https://bitpogo.github.io/kmock/0.3.0-rc03-SNAPSHOT/howto/advanced/ rel=canonical><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.3.0, mkdocs-material-8.5.0"><title>Advanced Concepts - KMock</title><link rel=stylesheet href=../../assets/stylesheets/main.2e8b5541.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.cbb835fc.min.css><link rel=stylesheet href=../../assets/extra.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=indigo data-md-color-primary data-md-color-accent> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#advanced-concepts class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <div data-md-component=outdated hidden> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title=KMock class="md-header__button md-logo" aria-label=KMock data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> KMock </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Advanced Concepts </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=indigo data-md-color-primary data-md-color-accent aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: light dark)" data-md-color-scheme=slate data-md-color-primary data-md-color-accent aria-label="Switch to light mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/bitPogo/kmock title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> bitPogo/kmock </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title=KMock class="md-nav__button md-logo" aria-label=KMock data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> KMock </label> <div class=md-nav__source> <a href=https://github.com/bitPogo/kmock title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> bitPogo/kmock </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> Home </a> </li> <li class=md-nav__item> <a href=../../quickstart/ class=md-nav__link> Quickstart </a> </li> <li class=md-nav__item> <a href=../../changelog/ class=md-nav__link> Changelog </a> </li> <li class=md-nav__item> <a href=../../roadmap/ class=md-nav__link> Roadmap </a> </li> <li class=md-nav__item> <a href=../../concept/ class=md-nav__link> Concept </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_6 type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6> How To <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="How To" data-md-level=1> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> How To </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../install/ class=md-nav__link> Installation </a> </li> <li class=md-nav__item> <a href=../setup/ class=md-nav__link> Setup </a> </li> <li class=md-nav__item> <a href=../terminology/ class=md-nav__link> Terminology </a> </li> <li class=md-nav__item> <a href=../annotations/ class=md-nav__link> Declaring a Mock </a> </li> <li class=md-nav__item> <a href=../proxy/ class=md-nav__link> Using Mocks </a> </li> <li class=md-nav__item> <a href=../assertion/ class=md-nav__link> Assertion/Verification </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_7 type=checkbox id=__nav_7> <label class=md-nav__link for=__nav_7> Development <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Development data-md-level=1> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> Development </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../development/code-of-conduct/ class=md-nav__link> Code of Conduct </a> </li> <li class=md-nav__item> <a href=../../development/contributing/ class=md-nav__link> Contributing </a> </li> <li class=md-nav__item> <a href=../../development/releasing/ class=md-nav__link> Releasing </a> </li> <li class=md-nav__item> <a href=../../development/badges/ class=md-nav__link> Badges </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../migration/ class=md-nav__link> Migration Guide </a> </li> <li class=md-nav__item> <a href=../../security/ class=md-nav__link> Security Policy </a> </li> <li class=md-nav__item> <a href=../../license/ class=md-nav__link> License </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#spying class=md-nav__link> Spying </a> <nav class=md-nav aria-label=Spying> <ul class=md-nav__list> <li class=md-nav__item> <a href=#special-behaviour-of-spies class=md-nav__link> Special behaviour of Spies </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#relaxing class=md-nav__link> Relaxing </a> </li> <li class=md-nav__item> <a href=#memory-model class=md-nav__link> Memory Model </a> </li> <li class=md-nav__item> <a href=#customization class=md-nav__link> Customization </a> <nav class=md-nav aria-label=Customization> <ul class=md-nav__list> <li class=md-nav__item> <a href=#argumentconstraints class=md-nav__link> ArgumentConstraints </a> </li> <li class=md-nav__item> <a href=#verification class=md-nav__link> Verification </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/bitPogo/kmock/tree/main/docs/src/howto/advanced.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg> </a> <h1 id=advanced-concepts>Advanced Concepts<a class=headerlink href=#advanced-concepts title="Permanent link">&para;</a></h1> <h2 id=spying>Spying<a class=headerlink href=#spying title="Permanent link">&para;</a></h2> <p>KMock supports Spying to a certain degree. While you still need to instantiate the <em>subject to spy on</em> (SO) by hand, you can delegate the SO to <code>kspy</code> and voila habemus spy!</p> <p>However Spying is disabled by default and is selective. To enable it please take a look at the <a href=../setup/ >Configuration of the Gradle Plugin</a>.</p> <p>Once it is enabled KMock will generate an additional factory <code>kspy</code>. <code>kspy</code> works similar to <code>kmock</code> and takes 3 arguments <code>spyOn</code>, <code>collect</code> and <code>freeze</code>. <code>spyOn</code> expects the SO and you need to reference the Mock Class.</p> <div class=highlight><pre><span></span><code><span class=nd>@Test</span><span class=w></span>
<span class=kd>fun</span><span class=w> </span><span class=nf>sampleTest</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=c1>// arrange</span><span class=w></span>
<span class=w>    </span><span class=kd>val</span><span class=w> </span><span class=nv>subjectToSpyOn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>AnyImplementation</span><span class=p>()</span><span class=w></span>
<span class=w>    </span><span class=kd>val</span><span class=w> </span><span class=nv>someInstance</span><span class=p>:</span><span class=w> </span><span class=n>SomeInterfaceMock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>kspy</span><span class=p>(</span><span class=n>spyOn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>subjectToSpyOn</span><span class=p>)</span><span class=w></span>

<span class=w>   </span><span class=p>...</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>Also as with <code>kmock</code>, if the Template is generic you have to delegate an additional argument <code>templateType</code> which must be the KClass of the Template the Spy is referring to. Spies for MultiMocks will always treated like they are generic. This means you have to delegate all template types the multi mock is referring to:</p> <div class=highlight><pre><span></span><code><span class=nd>@Test</span><span class=w></span>
<span class=kd>fun</span><span class=w> </span><span class=nf>sampleTest</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=c1>// arrange</span><span class=w></span>
<span class=w>    </span><span class=kd>val</span><span class=w> </span><span class=nv>subjectToSpyOn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>AnyMultiImplementation</span><span class=p>()</span><span class=w></span>
<span class=w>    </span><span class=kd>val</span><span class=w> </span><span class=nv>someInstance</span><span class=p>:</span><span class=w> </span><span class=n>SomeInterfaceMock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>kspy</span><span class=p>(</span><span class=w></span>
<span class=w>        </span><span class=n>spyOn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>subjectToSpyOn</span><span class=p>,</span><span class=w></span>
<span class=w>        </span><span class=n>templateType0</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>CharSequence</span><span class=o>::</span><span class=n>class</span><span class=p>,</span><span class=w></span>
<span class=w>        </span><span class=n>templateType1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Comparable</span><span class=o>::</span><span class=n>class</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=p>)</span><span class=w></span>
<span class=w>   </span><span class=p>...</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>You still can override specific methods or properties by using the corresponding Proxy Property. In other words methods or properties of an SO are used instead of throwing an error, if no behaviour or stub was assigned to a Proxy, so it acts completely non intrusive.</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>Setters are always invoked.</p> </div> <h3 id=special-behaviour-of-spies>Special behaviour of Spies<a class=headerlink href=#special-behaviour-of-spies title="Permanent link">&para;</a></h3> <p>In terms of Spies there is one big difference you need to be aware of. Since Build-In methods like <code>equals</code> are delegated to the SO as well it might result in a behaviour which is not obvious right away:</p> <div class=highlight><pre><span></span><code><span class=nd>@Test</span><span class=w></span>
<span class=kd>fun</span><span class=w> </span><span class=nf>sampleTest</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>   </span><span class=kd>val</span><span class=w> </span><span class=nv>subjectToSpyOn</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>AnyImplementation</span><span class=p>()</span><span class=w></span>
<span class=w>   </span><span class=kd>val</span><span class=w> </span><span class=nv>someInstance</span><span class=p>:</span><span class=w> </span><span class=n>SomeInterfaceMock</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>kspy</span><span class=p>(</span><span class=n>subjectToSpyOn</span><span class=p>)</span><span class=w></span>

<span class=w>   </span><span class=n>assertTrue</span><span class=p>((</span><span class=n>someInstance</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>Any</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>someInstance</span><span class=p>)</span><span class=w> </span><span class=c1>// will pass</span><span class=w></span>
<span class=w>   </span><span class=n>assertTrue</span><span class=p>((</span><span class=n>someInstance</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>Any</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>subjectToSpyOn</span><span class=p>)</span><span class=w> </span><span class=c1>// will pass</span><span class=w></span>
<span class=w>   </span><span class=n>assertTrue</span><span class=p>((</span><span class=n>subjectToSpyOn</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>Any</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>someInstance</span><span class=p>)</span><span class=w> </span><span class=c1>// will fail</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> <p>While the first and second Assertion passes the last won't. Why is it that? KMock uses inheritance not reflection as you remember. The last assertion fails since <code>AnyImplementation</code> has no custom implementation of <code>equals</code> and uses the default one. If <code>AnyImplementation</code> makes a custom comparison while taking only properties into account, the Assertion may pass.</p> <h2 id=relaxing>Relaxing<a class=headerlink href=#relaxing title="Permanent link">&para;</a></h2> <p>KMock also facilitates Relaxation to a certain degree and will hopefully get better in it over time. However it requires boilerplate code done by you. The Relaxation of methods which return <code>Unit</code> is Build-In feature, so do not worry about it. You only need to switch <code>relaxUnitFun</code> to <code>true</code> and be done with it.</p> <p>Similar things apply for Build-In methods, if they are enabled. They will fallback to their parents Build-In methods if no return value is set for them.</p> <p>To get full Relaxation support you need to implement a Relaxer function and annotate it properly: <div class=highlight><pre><span></span><code><span class=nd>@Relaxer</span><span class=w></span>
<span class=kd>internal</span><span class=w> </span><span class=kd>inline</span><span class=w> </span><span class=kd>fun</span><span class=w> </span><span class=o>&lt;</span><span class=k>reified</span><span class=w> </span><span class=n>T</span><span class=o>&gt;</span><span class=w> </span><span class=nf>relax</span><span class=p>(</span><span class=n>id</span><span class=p>:</span><span class=w> </span><span class=kt>String</span><span class=p>):</span><span class=w> </span><span class=n>T</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>   </span><span class=p>...</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</code></pre></div> The Annotation <code>@Relaxer</code> tells KMock that a Relaxer is present and is up for usage. The Relaxer can be an arbitrary function but has to follow a specific signature, similar as shown above. The function can be either inline or not. The type parameter can be either <code>reified</code> or not, but must be present and used as the return value. There can be only one type parameter. The function can be marked as internal or not, but must be visible by the Mocks. Also the function must take exactly one argument, which is a String. This argument will be provided when invoked by a Proxy and is its id. You may use it to differentiate between Proxies. At last you need to switch relaxing on by adding <code>relaxed = true</code> to <code>kmock</code>.</p> <p>However since this sounds cumbersome you may want to use it together with <a href=http://kfixture.antibytes.tech>KFixture</a>.</p> <p>Well, in certain cases the type parameter will not work as return value - Generics. If KMock encounters Generics as return values of a method/property it adds additional arguments (<code>type$Idx</code>) to invocation of the Relaxer Function For example: <div class=highlight><pre><span></span><code><span class=n>relax</span><span class=p>(</span><span class=w></span>
<span class=w>    </span><span class=n>proxyId</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>type0</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kt>Any</span><span class=o>::</span><span class=n>class</span><span class=p>,</span><span class=w></span>
<span class=w>    </span><span class=n>type1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Comparable</span><span class=o>::</span><span class=n>class</span><span class=p>,</span><span class=w></span>
<span class=p>)</span><span class=w></span>
</code></pre></div> This means KMock expects you to provide a proper definition of <code>fun relax(proxyId: String, type0: KClass&lt;Any&gt;, type1: KClass&lt;Comparable&lt;Any&gt;&gt;): Any</code>. The amount of type arguments depends on the boundaries of the generic return type. For example <code>&lt;T&gt; fun method(): T where T: Any, T: Comparable&lt;Any&gt;</code> will resolved to the invocation above.</p> <h2 id=memory-model>Memory Model<a class=headerlink href=#memory-model title="Permanent link">&para;</a></h2> <p>KMock still uses Kotlin's ‘old’ Memory Model. Therefore you might run into some trouble in certain cases.</p> <p>Both factory functions - <code>kmock</code> and <code>kspy</code> - take an argument <code>freeze</code> which is true by default. This means everything which is delegated to an Proxy (including Relaxation) or Verifier must conform with the freezing Memory Model of Kotlin. By switching <code>freeze</code> to <code>false</code> it changes the flavour to non-freezing.</p> <p>If you use non freezing Mocks, make sure you use the corresponding Asserter/Verifier (<code>NonFreezingVerifier</code>/<code>NonFreezingAsserter</code>) and all interacting Mocks are non-freezing as well. This is inconvenient for now but will go away once the new Memory Model is more stable.</p> <h2 id=customization>Customization<a class=headerlink href=#customization title="Permanent link">&para;</a></h2> <h3 id=argumentconstraints>ArgumentConstraints<a class=headerlink href=#argumentconstraints title="Permanent link">&para;</a></h3> <p>KMock is capable of using your custom defined ArgumentConstraints. You can simply extend <code>ArgumentConstraint</code> of the <code>KMockContract</code> and implement the functionality you require and use it. Done!</p> <h3 id=verification>Verification<a class=headerlink href=#verification title="Permanent link">&para;</a></h3> <p>While nearly all Assertion/Verification methods are not able to extended, you are still able to customize <code>verify</code> due to the power of <a href=https://kotlinlang.org/docs/extensions.html>extension function</a> for either the <code>Proxy</code>, <code>FunProxy</code>, <code>PropertyProxy</code>, <code>SyncFunProxy</code> or <code>AsyncFunProxy</code> Interface of the <code>KMockContract</code>. KMock exposes 4 functions which are intended for this purpose. <code>getArgumentsByType</code>, <code>getAllArgumentsByType</code> and <code>getAllArgumentsBoxedByType</code> working only for FunProxies, while <code>getArgumentsForCall</code> works for all Proxy types. <code>getArgumentsByType</code> can be used to retrieve Arguments for a specific call and type, <code>getAllArgumentsByType</code> and <code>getAllArgumentsBoxedByType</code> collecting over all invocations. The main difference between the latter methods is simply that <code>getAllArgumentsByType</code> will collect arguments in a linear order, while <code>getAllArgumentsBoxedByType</code> will box them in a List per call.</p> <p>Use those methods with caution, since they are likely subject to changes, once the concept of assertions gets a second look. KMock itself uses <code>getArgumentsForCall</code> which you might wanna use as well while working with PropertyProxies or you need a type unaware method to extract arguments from Proxies.</p> <p>Happy coding!</p> </article> </div> </div> <a href=# class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> Back to top </a> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2022 Matthias Geisler </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/bitPogo/kmock target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["navigation.tracking", "navigation.top"], "search": "../../assets/javascripts/workers/search.ecf98df9.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "version": {"provider": "mike"}}</script> <script src=../../assets/javascripts/bundle.48f2be22.min.js></script> </body> </html>